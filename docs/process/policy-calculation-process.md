# Policy Calculation and Persistence Process

## Purpose

Документ описывает:
- процесс расчёта страховой премии
- взаимодействие слоёв системы
- ответственность компонентов

Документ предназначен для:
- backend-разработчиков
- архитекторов
- QA
- актуариев

---

## High-Level Flow

JSON
→ PolicyDTO
→ PreProcessor
→ ContextVar
→ Calculator
→ ContextVar
→ PolicyDTO
→ PolicyEntity
→ DB


---

## Step-by-Step Process

### 1. Input

**Источник:** HTTP API  
**Формат:** JSON

На данном этапе выполняется:
- валидация формата
- десериализация

---

### 2. JSON → PolicyDTO

Ответственность:
- Jackson
- API-контракты
- типизация данных

Примеры типов:
- `BigDecimal` — деньги
- `LocalDate` — даты
- `Long` — идентификаторы

---

### 3. PreProcessor (Product Enrichment)

Назначение:
- обогащение договора метаданными продукта

Примеры:
- дефолтные покрытия
- лимиты
- derived attributes

Ограничения:
- ❌ не считает премию
- ❌ не содержит формул

---

### 4. PolicyDTO → ContextVar

Назначение:
- подготовка данных для калькулятора

Характеристики `ContextVar`:
- плоская структура
- примитивные типы
- отсутствие доменных сущностей

Пример:
insuredAge
termInMonths
sumInsured
riskClass

---     

### 5. Calculator

Характеристики:
stateless
deterministic
side-effect free

Вход:
ContextVar (Input)

Выход:
CalculationResult / ContextVar (Output)

---   

### 6. Calculation Result → ContextVar

Добавляемые данные:
premium
coefficients
tariff version
calculation trace

---    
   
### 7. ContextVar → PolicyDTO

Назначение:
перенос результатов расчёта обратно в договор

Результаты:
рассчитанная премия
детализация
explain information

---    
   
### 8. PolicyDTO → PolicyEntity

Назначение:
подготовка к сохранению

Хранение:
jsonPayload — снапшот договора

отдельные колонки:
premium
productCode
status

---   
   
### 9. Persistence

Назначение:
долговременное хранение
аудит
пересчёт

---   
   
### Rules & Restrictions

❌ Калькулятор не использует DTO    
❌ DTO не используется в Entity    
❌ Entity не участвует в расчёте    
❌ PreProcessor не выполняет расчёт    

---   
   
~~~
┌──────────────────────────────────────────────────────────┐
│                       API / Transport                    │
│                                                          │
│   HTTP Request                                           │
│   ────────────                                           │
│   JSON (string)                                          │
└───────────────┬──────────────────────────────────────────┘
                │
                ▼
┌──────────────────────────────────────────────────────────┐
│                 Orchestration Layer                      │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ JSON → PolicyDTO                                  │   │
│  │  - Jackson                                        │   │
│  │  - API validation                                 │   │
│  └──────────────────────────────────────────────────┘   │
│                │                                         │
│                ▼                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │ PreProcessor                                      │   │
│  │  - enrich with Product Metadata                   │   │
│  │  - defaults                                       │   │
│  │  - derived (non-calculation) values               │   │
│  └──────────────────────────────────────────────────┘   │
│                │                                         │
│                ▼                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │ PolicyDTO → ContextVar Mapper                     │   │
│  └──────────────────────────────────────────────────┘   │
└───────────────┬──────────────────────────────────────────┘
                │
                ▼
┌──────────────────────────────────────────────────────────┐
│                  Calculation Layer                      │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ ContextVar (Input)                                │   │
│  │  - primitives only                                │   │
│  └──────────────────────────────────────────────────┘   │
│                │                                         │
│                ▼                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │ Calculator                                        │   │
│  │  - pure function                                  │   │
│  │  - no DB / no DTO / no JSON                       │   │
│  └──────────────────────────────────────────────────┘   │
│                │                                         │
│                ▼                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │ CalculationResult / ContextVar(Output)            │   │
│  │  - premium                                        │   │
│  │  - coefficients                                   │   │
│  │  - trace                                          │   │
│  └──────────────────────────────────────────────────┘   │
└───────────────┬──────────────────────────────────────────┘
                │
                ▼
┌──────────────────────────────────────────────────────────┐
│                 Post-Processing Layer                   │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ ContextVar → PolicyDTO Mapper                     │   │
│  │  - enrich with calculation results                │   │
│  └──────────────────────────────────────────────────┘   │
└───────────────┬──────────────────────────────────────────┘
                │
                ▼
┌──────────────────────────────────────────────────────────┐
│                  Persistence Layer                      │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ PolicyDTO → PolicyEntity                          │   │
│  │  - jsonPayload (snapshot)                         │   │
│  │  - indexed fields                                 │   │
│  └──────────────────────────────────────────────────┘   │
│                │                                         │
│                ▼                                         │
│              Database                                   │
└──────────────────────────────────────────────────────────┘

~~~
