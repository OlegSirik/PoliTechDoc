# ADR-001: Policy Calculation and Persistence Architecture

## Status
Accepted

## Date
2025-XX-XX

## Context

Система страхования должна:
- поддерживать разные страховые продукты
- обеспечивать воспроизводимый расчёт премии
- изолировать калькулятор от структуры договора
- сохранять состояние договора для аудита и пересчёта

На вход системы поступает JSON договора, который:
- обогащается данными продукта
- используется для расчёта
- сохраняется в БД в виде снапшота

---

## Decision

Принято решение использовать **многоуровневую архитектуру** с изолированным калькулятором и промежуточной моделью `ContextVar`.

Ключевые решения:

1. API DTO (`PolicyDTO`) используется **только** на уровне оркестрации.
2. Калькулятор работает **исключительно** с `ContextVar`.
3. `ContextVar` является анти-коррупционным слоем между договором и расчётом.
4. Результаты расчёта возвращаются обратно в `PolicyDTO`.
5. Договор сохраняется как:
   - JSON-снапшот
   - структурированные колонки (для поиска и отчётов)

---

## Architecture Overview
JSON
→ PolicyDTO
→ PreProcessor (product enrichment)
→ ContextVar
→ Calculator
→ ContextVar (with results)
→ PolicyDTO
→ PolicyEntity (JSON snapshot)
→ Database


---

## Consequences

### Positive
- Калькулятор полностью изолирован от доменной модели
- Упрощена поддержка новых продуктов
- Возможен пересчёт договоров
- Поддержка explainable pricing
- Упрощён аудит и регуляторная проверка

### Negative
- Дополнительные маппинги
- Больше моделей и классов
- Более строгая дисциплина разработки

---

## Constraints

- Калькулятор не имеет доступа к БД
- Калькулятор не знает о Policy / Coverage / InsuredPerson
- PreProcessor не выполняет расчётов
- Entity не участвует в расчёте

---

## Alternatives Considered

### 1. Расчёт внутри PolicyDomain
❌ Отказано — сильная связность и плохая расширяемость

### 2. Передача PolicyDTO в калькулятор
❌ Отказано — калькулятор становится зависим от API

### 3. Расчёт напрямую из Entity
❌ Отказано — нарушение слоёв и невозможность пересчёта

---

## Related Documents
- docs/process/policy-calculation-process.md

